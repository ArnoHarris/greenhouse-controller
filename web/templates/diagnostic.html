{% extends "base.html" %}

{% block content %}
<div class="diag-layout">

  <!-- Shared time range + stats header -->
  <div class="diag-header">
    <div class="range-select-wrap" style="max-width:220px">
      <span class="range-icon">ğŸ•</span>
      <select id="diag-range" class="range-select" onchange="_diagOffset=0; loadDiagCharts()">
        <option value="1h">Last 1 hour</option>
        <option value="24h" selected>Last 24 hours</option>
        <option value="7d">Last 7 days</option>
        <option value="30d">Last 30 days</option>
      </select>
      <span class="range-arrow">â–¼</span>
    </div>
    <div class="date-nav">
      <button class="date-nav-btn" onclick="shiftDiagRange(-1)">â€¹</button>
      <span class="date-nav-label" id="diag-date-label">â€”</span>
      <button class="date-nav-btn" onclick="shiftDiagRange(+1)">â€º</button>
    </div>
    <div class="diag-stats-inline">
      <span class="diag-stat">Model RMSE: <strong id="diag-rmse">â€”</strong></span>
      <span class="diag-stat">Bias: <strong id="diag-bias">â€”</strong></span>
      <span class="diag-stat">n: <strong id="diag-n">â€”</strong></span>
    </div>
  </div>

  <!-- 1. Temperature overlay: actual vs predicted -->
  <div class="panel diag-panel">
    <div class="panel-title">temperature overlay â€” actual vs. model prediction</div>
    <div class="chart-wrap chart-wrap-full">
      <canvas id="diag-chart"></canvas>
    </div>
  </div>

  <!-- 2. Solar forecast vs actual -->
  <div class="panel diag-panel">
    <div class="panel-title">solar irradiance â€” forecast vs. actual</div>
    <div class="chart-wrap chart-wrap-full">
      <canvas id="solar-chart"></canvas>
    </div>
  </div>

  <!-- 3. Actuator timeline -->
  <div class="panel diag-panel diag-panel-tall">
    <div class="panel-title">actuator timeline</div>
    <div class="chart-wrap chart-wrap-full">
      <canvas id="timeline-chart"></canvas>
    </div>
  </div>

  <!-- 4. HVAC runtime -->
  <div class="panel diag-panel">
    <div class="panel-title">HVAC runtime (hours/day)</div>
    <div class="chart-wrap chart-wrap-full">
      <canvas id="hvac-runtime-chart"></canvas>
    </div>
  </div>

  <!-- 5. Power consumption -->
  <div class="panel diag-panel">
    <div class="panel-title">power consumption</div>
    <div class="chart-controls">
      <div class="range-select-wrap">
        <span class="range-icon">ğŸ•</span>
        <select id="diag-power-range" class="range-select" onchange="loadDiagPowerChart()">
          <option value="1h">Last 1 hour</option>
          <option value="24h" selected>Last 24 hours</option>
          <option value="7d">Last 7 days</option>
          <option value="30d">Last 30 days</option>
        </select>
        <span class="range-arrow">â–¼</span>
      </div>
      <div class="date-nav">
        <button class="date-nav-btn" onclick="shiftDiagPowerRange(-1)">â€¹</button>
        <span class="date-nav-label" id="diag-power-date-label">â€”</span>
        <button class="date-nav-btn" onclick="shiftDiagPowerRange(+1)">â€º</button>
      </div>
    </div>
    <div class="chart-wrap chart-wrap-full">
      <canvas id="diag-power-chart"></canvas>
    </div>
  </div>


  <!-- 6. Shade battery -->
  <div class="panel diag-panel">
    <div class="panel-title" style="display:flex;align-items:center;gap:12px;">
      shade battery &amp; status
      <button class="date-nav-btn" onclick="loadShadeBattery()" title="Refresh">&#8635;</button>
    </div>
    <table class="shade-battery-table" id="shade-battery-table">
      <thead>
        <tr>
          <th>Group</th><th>MAC</th><th>Type</th><th>Position</th><th>Battery</th><th>RSSI</th>
        </tr>
      </thead>
      <tbody id="shade-battery-body">
        <tr><td colspan="6" class="shade-battery-loading">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>

</div>
{% endblock %}

{% block page_script %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script>
  initDiagnosticPage();
</script>
{% endblock %}
